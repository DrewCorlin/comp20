<!DOCTYPE html>
<html>
  <head>
    <title>Landmarks</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
  </head>
  <body>
    <div id="map"></div>
    <script>
      var lat, lng, response, landmarks, people, map, myLoc;
      
      function initMap(){
        map = new google.maps.Map(document.getElementById('map'), 
        {
          center: { lat: 42.406784, lng: -71.122633 },
          zoom: 15
        });
      }

      function createMyMarker(){
        var myPos = { lat: lat, lng: lng };
        var lowestDistance = 10000000000;
        var closestLandmark, tempDistance;

        for (var x = 0; x < landmarks.length; x++){
          landmarkLoc = new google.maps.LatLng({
            lat: landmarks[x].geometry.coordinates[1], lng: landmarks[x].geometry.coordinates[0] 
          });
          tempDistance = google.maps.geometry.spherical.computeDistanceBetween(myLoc, landmarkLoc);
          if (tempDistance < lowestDistance){
            lowestDistance = tempDistance;
            closestLandmark = landmarks[x];
          }
        }
        // Convert to miles
        lowestDistance = lowestDistance/1609.34;
        var markerTitle = '<p>' + closestLandmark.properties.Location_Name + '</p>' + '<p> Distance: ' + lowestDistance + ' Miles </p>';
        createMarker(myPos, map, markerTitle, 'pic.png').setMap(map);
      }

      function createMarkers(){
        for (var i = 0; i < landmarks.length; i++) {
          var pos = { lat: landmarks[i].geometry.coordinates[1], lng: landmarks[i].geometry.coordinates[0] };
          createMarker(pos, map, landmarks[i].properties.Details).setMap(map);
        }
      }

      function createMarker(positionArg, mapArg, titleArg, img){
        var marker = new google.maps.Marker({
          position: positionArg,
          title: titleArg,
          icon: img
        });

        myLoc = new google.maps.LatLng({ lat: lat, lng: lng });
        var otherLoc = new google.maps.LatLng({ lat: positionArg.lat, lng: positionArg.lng});

        var distance = google.maps.geometry.spherical.computeDistanceBetween(myLoc, otherLoc);
        // Convert to miles
        distance = distance/1609.34;
        
        var infowindow = new google.maps.InfoWindow({
          content: titleArg
        });

        marker.addListener('click', function(){
          infowindow.open(mapArg, marker);
        });

        return marker;
      }

      
      function storeLatLng(position) {
        lat = position.coords.latitude;
        lng = position.coords.longitude;
        sendRequest(lat, lng);
      }
      
      function storeLocation(){
        navigator.geolocation.getCurrentPosition(storeLatLng);
      }
      
      storeLocation();
      
      var xhr = new XMLHttpRequest();
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState == XMLHttpRequest.DONE) {
          response = JSON.parse(xhr.responseText);
          landmarks = response.landmarks;
          people = response.people;
          createMarkers();
          createMyMarker();
        }
      }
      
      function sendRequest(latitude, longitude){
        xhr.open('POST', "https://defense-in-derpth.herokuapp.com/sendLocation");
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhr.send("login=HGmgDS0E&lat=" + latitude + "&lng=" + longitude);
      }

    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC3-FjpeNtlQLUSClPJKxIDjagGNx_sw2I&callback=initMap&libraries=geometry"
    async defer></script>
  </body>
</html>