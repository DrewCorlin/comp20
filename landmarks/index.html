<!DOCTYPE html>
<html>
  <head>
    <title>Landmarks</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
  </head>
  <body>
    <div id="map"></div>
    <script>
      var lat, lng, response, landmarks, people, map;
      
      function initMap(){
        map = new google.maps.Map(document.getElementById('map'), 
        {
          center: { lat: 42.406784, lng: -71.122633 },
          zoom: 15
        });
      }

      function createMarkers(){
        console.log(landmarks);
        for (var i = 0; i < landmarks.length; i++) {
          var pos = { lat: landmarks[i].geometry.coordinates[1], lng: landmarks[i].geometry.coordinates[0] }
          createMarker(pos, map, landmarks[i].properties.Details).setMap(map);
          console.log(pos);
        }
      }

      function createMarker(positionArg, mapArg, titleArg){
        var marker = new google.maps.Marker({
          position: positionArg,
          title: titleArg
        });

        var myLoc = new google.maps.LatLng({ lat: lat, lng: lng });
        var otherLoc = new google.maps.LatLng({ lat: positionArg.lat, lng: positionArg.lng});

        var distance = google.maps.geometry.spherical.computeDistanceBetween(myLoc, otherLoc);
        // Convert to miles
        distance = distance/1609.34;
        
        var infowindow = new google.maps.InfoWindow({
          content: titleArg
        });

        marker.addListener('click', function(){
          infowindow.open(mapArg, marker);
        });

        return marker;
      }

      
      function storeLatLng(position) {
        lat = position.coords.latitude;
        lng = position.coords.longitude;
        sendRequest(lat, lng);
      }
      
      function storeLocation(){
        navigator.geolocation.getCurrentPosition(storeLatLng);
      }
      
      storeLocation();
      
      var xhr = new XMLHttpRequest();
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState == XMLHttpRequest.DONE) {
          response = JSON.parse(xhr.responseText);
          landmarks = response.landmarks;
          people = response.people;
          createMarkers();
        }
      }
      
      function sendRequest(latitude, longitude){
        xhr.open('POST', "https://defense-in-derpth.herokuapp.com/sendLocation");
        xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xhr.send("login=HGmgDS0E&lat=" + latitude + "&lng=" + longitude);
      }

    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC3-FjpeNtlQLUSClPJKxIDjagGNx_sw2I&callback=initMap&libraries=geometry"
    async defer></script>
  </body>
</html>